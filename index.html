<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Japan Winter Trip</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue.js 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap"
        rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'snow-blue': '#E3F2FD',
                        'ice-blue': '#BBDEFB',
                        'deep-blue': '#1565C0',
                        'text-dark': '#37474F',
                        'text-light': '#78909C',
                        'accent': '#FF7043',
                        'card-blue': '#0D47A1'
                    },
                    fontFamily: {
                        sans: ['Noto Sans TC', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #E3F2FD;
            -webkit-tap-highlight-color: transparent;
        }

        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .blue-card {
            background: linear-gradient(135deg, #1565C0 0%, #0D47A1 100%);
            color: white;
        }

        /* Mobile-like card transitions */
        .card-enter-active,
        .card-leave-active {
            transition: all 0.3s ease;
        }

        .card-enter-from,
        .card-leave-to {
            opacity: 0;
            transform: translateY(20px);
        }

        .fade-enter-active,
        .fade-leave-active {
            transition: opacity 0.3s;
        }

        .fade-enter-from,
        .fade-leave-to {
            opacity: 0;
        }
    </style>
</head>

<body class="text-text-dark">
    <div id="app" class="max-w-md mx-auto min-h-screen bg-snow-blue shadow-2xl relative overflow-hidden flex flex-col">

        <!-- Header Section -->
        <header class="relative z-10 shrink-0">
            <!-- Banner Image Container - Fixed Height 300px -->
            <div class="h-[300px] w-full overflow-hidden relative">
                <img src="./images/banner.png?v=3" alt="Travel Banner" class="w-full h-full object-cover object-bottom">

                <!-- Floating Tabs (Bottom Right of Banner) -->
                <div class="absolute bottom-12 right-4 flex space-x-3">
                    <button v-for="tab in tabs" :key="tab.id" @click="currentTab = tab.id" :class="[
                            'w-12 h-12 rounded-full flex items-center justify-center shadow-lg transition-transform active:scale-95 border-2',
                            currentTab === tab.id ? 'bg-deep-blue text-white border-white scale-110' : 'bg-white text-text-light border-transparent'
                        ]">
                        <i :class="tab.icon + ' text-lg'"></i>
                    </button>
                </div>
            </div>

            <!-- White Arc Transition -->
            <div class="absolute bottom-0 left-0 w-full h-12 bg-snow-blue rounded-t-[40px] translate-y-1"></div>
        </header>

        <!-- Main Content Area -->
        <main class="relative z-20 px-4 pb-24 -mt-2 flex-grow overflow-y-auto hide-scrollbar">

            <!-- Tab: Itinerary (ÊØèÊó•Ë°åÁ®ã) -->
            <transition name="card" mode="out-in">
                <div v-if="currentTab === 'itinerary'" key="itinerary">
                    <!-- Date Selector -->
                    <div
                        class="flex overflow-x-auto hide-scrollbar space-x-4 pb-4 mb-2 sticky top-0 bg-snow-blue/90 z-30 pt-2 backdrop-blur-sm">
                        <button v-for="(day, index) in days" :key="index" @click="currentDayIndex = index" :class="[
                                'flex flex-col items-center min-w-[60px] p-2 rounded-2xl transition-colors',
                                currentDayIndex === index ? 'bg-deep-blue text-white shadow-md' : 'bg-white text-text-light'
                            ]">
                            <span class="text-xs opacity-80">{{ day.weekday }}</span>
                            <span class="text-xl font-bold">{{ day.date }}</span>
                        </button>
                    </div>

                    <!-- Weather Widget -->
                    <div
                        class="bg-gradient-to-r from-blue-400 to-blue-300 text-white p-4 rounded-2xl shadow-lg mb-6 flex items-center justify-between">
                        <div>
                            <div class="text-3xl font-bold flex items-center">
                                <i class="fas fa-snowflake mr-3"></i>
                                -2¬∞C
                            </div>
                            <div class="text-sm opacity-90">È´îÊÑü -5¬∞C | ÊπØÊæ§Áî∫</div>
                        </div>
                        <i class="fas fa-cloud-snow text-4xl opacity-80"></i>
                    </div>

                    <!-- Itinerary List -->
                    <div class="space-y-4">
                        <div v-for="(item, index) in currentDayItinerary" :key="item.id || index"
                            class="relative group">

                            <!-- Time Connector -->
                            <div v-if="index > 0" class="flex justify-center items-center py-2">
                                <div class="h-6 w-0.5 bg-gray-300"></div>
                            </div>

                            <!-- Card -->
                            <div :class="[
                                'p-4 rounded-2xl shadow-sm relative overflow-hidden border-l-4',
                                item.category === 'Ëà™Áè≠' ? 'bg-blue-50 border-accent' : 'glass-panel border-transparent'
                                ]">

                                <div class="flex justify-between items-start mb-2">
                                    <div class="flex items-center space-x-2">
                                        <span class="font-mono font-bold text-deep-blue text-lg">{{ item.time }}</span>
                                        <span class="text-xs px-2 py-0.5 bg-gray-100 rounded-full text-gray-500">{{
                                            item.category }}</span>
                                    </div>
                                    <div class="flex space-x-2">
                                        <button
                                            v-if="item.name.includes('Skyliner') || item.name.includes('Ê©üÂ†¥') || item.category === '‰ΩèÂÆø' || item.category === 'ÁæéÈ£ü' || item.category === 'ÊôØÈªû'"
                                            @click="openGoogleMaps(item.name)"
                                            class="text-blue-400 hover:text-deep-blue">
                                            <i class="fas fa-location-arrow"></i>
                                        </button>
                                    </div>
                                </div>

                                <h3 class="font-bold text-lg text-text-dark">{{ item.name }}</h3>
                                <div class="text-sm text-gray-600 mt-1">{{ item.location }}</div>

                                <!-- Note / Price -->
                                <div v-if="item.note || item.price"
                                    class="mt-2 text-xs bg-white/50 p-2 rounded flex flex-col gap-1">
                                    <div v-if="item.note" class="text-gray-700">üìå {{ item.note }}</div>
                                    <div v-if="item.price" class="text-orange-500 font-bold">üí∞ È†êÁÆó: {{ item.price }}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Empty State -->
                        <div v-if="currentDayItinerary.length === 0" class="text-center text-gray-400 py-10">
                            Â∞öÊú™ÂÆâÊéíË°åÁ®ã
                        </div>
                    </div>
                </div>
            </transition>

            <!-- Tab: Info (Ë≥áË®ä) -->
            <transition name="card" mode="out-in">
                <div v-if="currentTab === 'info'" key="info" class="space-y-6">
                    <h2 class="text-2xl font-bold text-deep-blue mb-4">ÊóÖÈÅäË≥áË®ä</h2>

                    <!-- Exchange Rate (New Blue Design) -->
                    <div class="blue-card p-6 rounded-3xl shadow-xl">
                        <h3 class="font-bold mb-4 flex items-center text-lg"><i class="fas fa-calculator mr-2"></i> ÂåØÁéáÊèõÁÆó
                        </h3>

                        <div class="flex items-center justify-between gap-4 mb-2">
                            <div class="flex-1">
                                <div class="text-xs opacity-70 mb-1">JPY (Êó•Âπ£)</div>
                                <input type="number" v-model="exchangeAmount"
                                    class="w-full bg-white/20 text-white text-xl font-bold p-3 rounded-xl border border-white/30 focus:outline-none focus:bg-white/30 placeholder-white/50"
                                    placeholder="0">
                            </div>
                            <i class="fas fa-exchange-alt opacity-70 mt-4"></i>
                            <div class="flex-1">
                                <div class="text-xs opacity-70 mb-1">TWD (Âè∞Âπ£)</div>
                                <div
                                    class="w-full bg-white/10 text-white text-xl font-bold p-3 rounded-xl border border-white/10">
                                    $ {{ calculatedTWD }}
                                </div>
                            </div>
                        </div>
                        <div class="text-right text-xs opacity-60">ÂåØÁéáÂü∫Ê∫ñ: {{ exchangeRate }}</div>
                    </div>

                    <!-- Flights Info (Updated Scoot) -->
                    <div class="glass-panel p-5 rounded-2xl border-l-4 border-yellow-400">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-bold flex items-center"><i class="fas fa-plane text-yellow-500 mr-2"></i> ÈÖ∑Ëà™
                                Scoot</h3>
                            <span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded">Âê´20kgË®óÈÅã</span>
                        </div>

                        <!-- Outbound -->
                        <div class="mb-4 pb-4 border-b border-gray-100">
                            <div class="flex justify-between text-sm font-bold text-gray-500 mb-1">ÂéªÁ®ã 1/30 (‰∫î)</div>
                            <div class="flex justify-between items-center">
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-deep-blue">06:40</div>
                                    <div class="text-xs text-gray-400">TPE Âè∞Âåó</div>
                                </div>
                                <div class="flex flex-col items-center px-4">
                                    <span class="text-xs text-blue-500 font-mono mb-1">TR898</span>
                                    <i class="fas fa-long-arrow-alt-right text-gray-300"></i>
                                    <span class="text-[10px] text-gray-400 mt-1">3h 05m</span>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-deep-blue">10:45</div>
                                    <div class="text-xs text-gray-400">NRT ÊàêÁî∞</div>
                                </div>
                            </div>
                        </div>

                        <!-- Inbound -->
                        <div>
                            <div class="flex justify-between text-sm font-bold text-gray-500 mb-1">ÂõûÁ®ã 2/3 (‰∫å)</div>
                            <div class="flex justify-between items-center">
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-deep-blue">11:45</div>
                                    <div class="text-xs text-gray-400">NRT ÊàêÁî∞</div>
                                </div>
                                <div class="flex flex-col items-center px-4">
                                    <span class="text-xs text-blue-500 font-mono mb-1">TR899</span>
                                    <i class="fas fa-long-arrow-alt-right text-gray-300"></i>
                                    <span class="text-[10px] text-gray-400 mt-1">3h 25m</span>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-deep-blue">15:10</div>
                                    <div class="text-xs text-gray-400">TPE Âè∞Âåó</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </transition>

            <!-- Tab: Shopping (Ë≥ºÁâ©Ê∏ÖÂñÆ) -->
            <transition name="card" mode="out-in">
                <div v-if="currentTab === 'shopping'" key="shopping">
                    <h2 class="text-2xl font-bold text-deep-blue mb-4">Ë≥ºÁâ©Ê∏ÖÂñÆ</h2>

                    <!-- Folder View -->
                    <div v-if="!currentShoppingUser" class="grid grid-cols-1 gap-4">
                        <div v-for="user in users" :key="user" @click="currentShoppingUser = user"
                            class="glass-panel p-6 rounded-2xl flex items-center justify-between hover:bg-white transition-colors cursor-pointer">
                            <div class="flex items-center space-x-4">
                                <div
                                    class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center text-deep-blue font-bold text-xl">
                                    {{ user[0] }}
                                </div>
                                <div>
                                    <div class="font-bold text-lg">{{ user }}ÁöÑÊ∏ÖÂñÆ</div>
                                    <div class="text-xs text-gray-400">{{ shoppingList[user].length }} ÂÄãÈ†ÖÁõÆ</div>
                                </div>
                            </div>
                            <i class="fas fa-chevron-right text-gray-300"></i>
                        </div>
                    </div>

                    <!-- Detail View -->
                    <div v-else>
                        <button @click="currentShoppingUser = null"
                            class="mb-4 flex items-center text-gray-400 hover:text-deep-blue">
                            <i class="fas fa-arrow-left mr-2"></i> ËøîÂõûÂàóË°®
                        </button>
                        <h3 class="text-xl font-bold mb-4 flex items-center">
                            <span class="bg-deep-blue text-white text-xs px-2 py-1 rounded mr-2">{{ currentShoppingUser
                                }}</span>
                            ÁöÑË≥ºÁâ©Ê∏ÖÂñÆ
                        </h3>

                        <div class="grid grid-cols-2 gap-4">
                            <div v-for="(item, index) in shoppingList[currentShoppingUser]" :key="index"
                                @click="openBoughtModal(item, index)"
                                class="glass-panel rounded-2xl overflow-hidden relative group cursor-pointer hover:shadow-md transition-all border-2"
                                :class="item.bought ? 'border-green-400 opacity-60' : 'border-transparent'">

                                <div class="absolute top-2 right-2 z-10" v-if="item.bought">
                                    <i class="fas fa-check-circle text-green-500 text-xl bg-white rounded-full"></i>
                                </div>

                                <div class="h-32 bg-gray-100 relative">
                                    <img v-if="item.image" :src="item.image" class="w-full h-full object-cover">
                                    <div v-else class="w-full h-full flex items-center justify-center text-gray-300">
                                        <i class="fas fa-image text-2xl"></i>
                                    </div>
                                </div>
                                <div class="p-3">
                                    <div class="font-bold text-sm truncate">{{ item.name }}</div>
                                    <div v-if="item.boughPrice" class="text-xs text-green-600 font-bold mt-1">¬•{{
                                        item.boughPrice }}</div>
                                </div>
                            </div>
                        </div>

                        <!-- Add Button (In Detail View) -->
                        <button @click="showAddShoppingModal = true"
                            class="fixed bottom-6 right-6 w-14 h-14 bg-deep-blue text-white rounded-full shadow-2xl flex items-center justify-center text-2xl z-50 hover:scale-110 transition-transform">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
            </transition>

            <!-- Tab: Expenses (Ëä±Ë≤ªÁ¥ÄÈåÑ) -->
            <transition name="card" mode="out-in">
                <div v-if="currentTab === 'expenses'" key="expenses">
                    <h2 class="text-2xl font-bold text-deep-blue mb-4">Ëä±Ë≤ªÁ¥ÄÈåÑ</h2>

                    <!-- Sub Tabs -->
                    <div class="flex space-x-2 mb-6 bg-white/50 p-1 rounded-xl">
                        <button v-for="type in ['group', 'personal']" :key="type"
                            @click="currentExpenseTab = type; currentExpenseUser = null" :class="['flex-1 py-2 rounded-lg text-sm font-bold transition-all', 
                             currentExpenseTab === type ? 'bg-deep-blue text-white shadow' : 'text-gray-500']">
                            {{ type === 'group' ? 'ÂúòÈ´îÂÖ¨Ë≤ª' : 'ÂÄã‰∫∫Ëä±Ë≤ª' }}
                        </button>
                    </div>

                    <!-- GROUP EXPENSES -->
                    <div v-if="currentExpenseTab === 'group'">
                        <!-- Total Group Spending -->
                        <div class="bg-gray-800 text-white p-5 rounded-2xl shadow-lg mb-6">
                            <div class="text-sm opacity-80">ÂúòÈ´îÁ∏ΩÊîØÂá∫ (Total)</div>
                            <div class="text-4xl font-bold mt-1">¬• {{ totalGroupExpense.toLocaleString() }}</div>
                        </div>

                        <!-- User Advanced Cards -->
                        <div class="space-y-4">
                            <div v-for="user in users" :key="user" class="glass-panel p-4 rounded-2xl">
                                <div class="flex justify-between items-center mb-3">
                                    <div class="font-bold flex items-center">
                                        <div
                                            class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center mr-2 text-xs text-deep-blue">
                                            {{ user[0] }}</div>
                                        {{ user }} È†êÊîØ
                                    </div>
                                    <div class="font-bold text-deep-blue">¬• {{ groupExpenses.filter(e => e.payer ===
                                        user).reduce((acc, cur) => acc + Number(cur.amount), 0).toLocaleString() }}
                                    </div>
                                </div>
                                <!-- Items -->
                                <div class="space-y-2 border-t pt-2 border-gray-100">
                                    <div v-for="(item, idx) in groupExpenses.filter(e => e.payer === user)" :key="idx"
                                        class="flex justify-between text-sm">
                                        <span class="text-gray-600">{{ item.name }}</span>
                                        <div class="flex items-center space-x-2">
                                            <span>¬•{{ Number(item.amount).toLocaleString() }}</span>
                                            <button @click="deleteGroupExpense(item)"
                                                class="text-gray-300 hover:text-red-400"><i
                                                    class="fas fa-times"></i></button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- PERSONAL EXPENSES -->
                    <div v-if="currentExpenseTab === 'personal'">
                        <!-- User Folders -->
                        <div v-if="!currentExpenseUser" class="grid grid-cols-1 gap-4">
                            <div v-for="user in users" :key="user" @click="currentExpenseUser = user"
                                class="glass-panel p-6 rounded-2xl flex items-center justify-between hover:bg-white transition-colors cursor-pointer">
                                <div class="flex items-center space-x-4">
                                    <div
                                        class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center text-green-700 font-bold text-xl">
                                        {{ user[0] }}
                                    </div>
                                    <div>
                                        <div class="font-bold text-lg">{{ user }}ÁöÑËä±Ë≤ª</div>
                                        <div class="text-xs text-gray-400">Á∏ΩË®à: ¬• {{
                                            getPersonalTotal(user).toLocaleString() }}</div>
                                    </div>
                                </div>
                                <i class="fas fa-chevron-right text-gray-300"></i>
                            </div>
                        </div>

                        <!-- User Detail -->
                        <div v-else>
                            <button @click="currentExpenseUser = null"
                                class="mb-4 flex items-center text-gray-400 hover:text-deep-blue">
                                <i class="fas fa-arrow-left mr-2"></i> ËøîÂõûÂàóË°®
                            </button>

                            <div class="bg-green-600 text-white p-5 rounded-2xl shadow-lg mb-6">
                                <div class="text-sm opacity-80">{{ currentExpenseUser }} Á∏ΩÊîØÂá∫</div>
                                <div class="text-4xl font-bold mt-1">¬• {{
                                    getPersonalTotal(currentExpenseUser).toLocaleString() }}</div>
                            </div>

                            <div class="space-y-3">
                                <div v-for="(item, index) in personalExpenses[currentExpenseUser]" :key="index"
                                    class="glass-panel p-4 rounded-xl flex justify-between items-center">
                                    <div>
                                        <div class="font-bold text-gray-800">{{ item.name }}</div>
                                        <div class="text-xs text-gray-400 mt-0.5">{{ item.date }}</div>
                                    </div>
                                    <div class="text-right">
                                        <div class="font-bold text-lg">¬•{{ Number(item.amount).toLocaleString() }}</div>
                                        <button @click="deletePersonalExpense(currentExpenseUser, index)"
                                            class="text-xs text-red-300 p-1"><i class="fas fa-trash"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Add Button -->
                    <button @click="showAddExpenseModal = true"
                        class="fixed bottom-6 right-6 w-14 h-14 bg-deep-blue text-white rounded-full shadow-2xl flex items-center justify-center text-2xl z-50 hover:scale-110 transition-transform">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </transition>

        </main>

        <!-- MODALS -->

        <!-- Shopping Add Modal -->
        <div v-if="showAddShoppingModal"
            class="fixed inset-0 z-50 flex items-end justify-center bg-black/50 backdrop-blur-sm"
            @click.self="showAddShoppingModal = false">
            <div class="bg-white w-full max-w-md rounded-t-3xl p-6 shadow-2xl animate-slide-up">
                <h3 class="font-bold text-xl mb-4 text-center">Êñ∞Â¢ûË≥ºÁâ©Ê∏ÖÂñÆ ({{ currentShoppingUser }})</h3>
                <div class="space-y-3">
                    <input v-model="newShoppingItem.name" placeholder="ÂïÜÂìÅÂêçÁ®±" class="w-full p-3 bg-gray-50 rounded-xl">
                    <input type="file" @change="handleImageUpload" class="w-full p-3 bg-gray-50 rounded-xl text-sm">
                    <button @click="addShoppingItem"
                        class="w-full bg-deep-blue text-white py-3 rounded-xl font-bold mt-2">Á¢∫Ë™çÊñ∞Â¢û</button>
                </div>
            </div>
        </div>

        <!-- Bought Confirmation Modal -->
        <div v-if="showBoughtModal"
            class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm"
            @click.self="showBoughtModal = false">
            <div class="bg-white w-[90%] max-w-sm rounded-3xl p-6 shadow-2xl animate-fade">
                <h3 class="font-bold text-xl mb-2 text-center">{{ selectedShoppingItem?.name }}</h3>
                <div class="text-center text-gray-500 mb-6 text-sm">Ê®ôË®òÁÇ∫Â∑≤Ë≥ºË≤∑‰∏¶Ë®òÂ∏≥?</div>

                <div class="flex items-center space-x-2 mb-4 bg-gray-50 p-2 rounded-xl">
                    <input type="checkbox" id="isBought" v-model="boughtForm.isBought" class="w-5 h-5 text-deep-blue">
                    <label for="isBought" class="font-bold text-gray-700">ÊàëÂ∑≤Á∂ìË≤∑Âà∞‰∫Ü</label>
                </div>

                <div v-if="boughtForm.isBought" class="mb-4 animate-fade">
                    <label class="block text-xs text-gray-400 mb-1 ml-1">Ë≥ºÂÖ•ÈáëÈ°ç (Êó•Âπ£)</label>
                    <input type="number" v-model="boughtForm.price" placeholder="¬•"
                        class="w-full p-3 bg-gray-100 rounded-xl text-lg font-bold">
                    <div class="text-xs text-green-600 mt-2"><i class="fas fa-check"></i> Â∞áËá™ÂãïÂä†ÂÖ• {{ currentShoppingUser
                        }} ÁöÑÂÄã‰∫∫Â∏≥Êú¨</div>
                </div>

                <div class="flex space-x-3 pt-2">
                    <button @click="confirmBought"
                        class="flex-1 bg-deep-blue text-white py-3 rounded-xl font-bold">Á¢∫Ë™ç</button>
                    <button @click="showBoughtModal = false"
                        class="flex-none bg-gray-100 text-gray-500 px-4 py-3 rounded-xl">ÈóúÈñâ</button>
                </div>
            </div>
        </div>

        <!-- Expense Add Modal -->
        <div v-if="showAddExpenseModal"
            class="fixed inset-0 z-50 flex items-end justify-center bg-black/50 backdrop-blur-sm"
            @click.self="showAddExpenseModal = false">
            <div class="bg-white w-full max-w-md rounded-t-3xl p-6 shadow-2xl animate-slide-up">
                <h3 class="font-bold text-xl mb-4 text-center">Êñ∞Â¢û{{ currentExpenseTab === 'group' ? 'ÂúòÈ´î' : 'ÂÄã‰∫∫' }}Ëä±Ë≤ª
                </h3>

                <div class="space-y-4">
                    <!-- User Selector -->
                    <div>
                        <label class="block text-xs text-gray-400 mb-1 ml-1">{{ currentExpenseTab === 'group' ? 'Ë™∞È†êÊîØÁöÑÔºü'
                            : 'Ë®òÂú®Ë™∞ÁöÑÂ∏≥‰∏äÔºü' }}</label>
                        <div class="flex space-x-2">
                            <button v-for="user in users" :key="user" @click="newExpense.payer = user"
                                :class="['flex-1 py-2 rounded-xl text-sm font-bold border-2', 
                                newExpense.payer === user ? 'border-deep-blue bg-blue-50 text-deep-blue' : 'border-gray-100 text-gray-400']">
                                {{ user }}
                            </button>
                        </div>
                    </div>

                    <input v-model="newExpense.name" placeholder="È†ÖÁõÆÂêçÁ®±" class="w-full p-3 bg-gray-50 rounded-xl">
                    <input type="number" v-model="newExpense.amount" placeholder="ÈáëÈ°ç (Êó•Âπ£)"
                        class="w-full p-3 bg-gray-50 rounded-xl text-lg font-bold">

                    <button @click="addExpense"
                        class="w-full bg-deep-blue text-white py-3 rounded-xl font-bold mt-2">Ë®òÂ∏≥</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        const { createApp, ref, computed, watch } = Vue;

        createApp({
            setup() {
                const currentTab = ref('itinerary');
                const exchangeRate = ref(0.215);
                const exchangeAmount = ref('');

                // Users
                const users = ['Âë®Áëæ', 'ÁéâËèØ', '‰Ω≥Ëìâ'];

                // Days Definition
                const days = [
                    { date: '30', weekday: 'Fri' },
                    { date: '31', weekday: 'Sat' },
                    { date: '1', weekday: 'Sun' },
                    { date: '2', weekday: 'Mon' },
                    { date: '3', weekday: 'Tue' },
                ];
                const currentDayIndex = ref(0);

                // ITINERARY DATA (Parsed from UserRequest)
                const itineraryData = {
                    0: [ // Day 1 Fri
                        { time: '06:40', category: 'Ëà™Áè≠', name: 'ÊäµÈÅîÊó•Êú¨ (TR898)', location: 'ÊàêÁî∞Ê©üÂ†¥ (NRT)', note: 'Ëæ¶ÁêÜÂÖ•Â¢É„ÄÅÈ†òË°åÊùé' },
                        { time: '12:00', category: '‰∫§ÈÄö', name: 'Ê©üÂ†¥Âø´Á∑ö Skyliner', location: 'ÂæÄ‰∫¨Êàê‰∏äÈáéÊñπÂêë', note: 'ËªäÁ®ãÁ¥Ñ 41 ÂàÜÈêò' },
                        { time: '12:45', category: 'ÁæéÈ£ü', name: 'Âêç‰ª£ ÂÆáÂ•à„Å®„Å® (È∞ªÈ≠öÈ£Ø)', location: '‰∏äÈáéÂ∫ó', note: 'Ë≤∑‰æøÁï∂Ëªä‰∏äÂêÉ' },
                        { time: '13:46', category: '‰∫§ÈÄö', name: '‰∏äË∂äÊñ∞ÂππÁ∑ö (ÊåáÂÆöÂ∏≠)', location: 'ÂæÄË∂äÂæåÊπØÊæ§', note: 'ÈúÄÈ†êË®Ç' },
                        { time: '14:50', category: '‰ΩèÂÆø', name: 'Ë∂äÂæå‰πãÂæ°ÂÆø Inamoto', location: 'ËªäÁ´ôË•øÂè£Ê≠•Ë°å 1 ÂàÜÈêò', note: 'Check-in' },
                        { time: '15:30', category: 'ÊôØÈªû', name: 'Ê∏ÖÈÖíÂçöÁâ©È§® / ÁàÜÂΩàÈ£ØÁ≥∞', location: 'CoCoLo ÊπØÊæ§', price: '¬•500' },
                        { time: '16:30', category: 'ÁæéÈ£ü', name: 'ÁáíËÇâ SAKAEYA', location: '‰∫∫Ê∞£Â∫ó', price: '¬•6500', note: 'Âª∫Ë≠∞ÂÖàÁôªË®ò' },
                        { time: '19:00', category: '‰ΩèÂÆø', name: 'Èú≤Â§©Ê∫´Ê≥â', location: 'Inamoto', note: '‰ºëÊÅØ/Ê≥°ÊπØ' },
                    ],
                    1: [ // Day 2 Sat
                        { time: '09:30', category: '‰∫§ÈÄö', name: 'ÁßªÂãï: ÊîæË°åÊùé', location: 'ÂæÄ Ê´ªËä±‰∫≠', note: 'Ë®àÁ®ãËªä' },
                        { time: '10:10', category: 'ÊôØÈªû', name: 'Êé°ËçâËéìÈ´îÈ©ó', location: 'Ë∂äÂæåÊπØÊæ§ËçâËéìÂúí', price: '¬•2600', note: 'Èõ™ÂúãÊ∫´ÂÆ§ËçâËéì' },
                        { time: '12:00', category: 'ÁæéÈ£ü', name: 'Pizzeria Pittore', location: 'Â≤©ÂéüÊªëÈõ™Â†¥', note: '‰∫∫Ê∞£Êä´Ëñ©' },
                        { time: '13:30', category: 'ÊôØÈªû', name: 'Â≤©ÂéüÊªëÈõ™Â†¥ (ÊªëÈõ™ÁâπË®ì)', location: 'Iwappara', price: '¬•14000', note: 'ÁßüË£ùÂÇô„ÄÅË´ãÊïôÁ∑¥' },
                        { time: '18:40', category: 'ÁæéÈ£ü', name: 'ËªäÁ´ôÁæéÈ£ü', location: 'È£üËÑäÂ±ã/È£üÂÆ∂ „ÅÇ„Åï„Åè„Åï', note: 'ËïéÈ∫•È∫µ/ÁîüÈ≠öÁâá' },
                        { time: '21:00', category: '‰ΩèÂÆø', name: 'Ê´ªËä±‰∫≠ (Sakura Tei)', location: 'Check-in', note: '' },
                    ],
                    2: [ // Day 3 Sun
                        { time: '09:00', category: '‰∫§ÈÄö', name: 'ÂåÖËªäÂâçÂæÄÊ∏ÖÊ¥•Â≥Ω', location: 'Ê´ªËä±‰∫≠Âá∫Áôº', price: '¬•9500 (ÂÖ±)' },
                        { time: '10:00', category: 'ÊôØÈªû', name: 'Ê∏ÖÊ¥•Â≥Ω Tunnel of Light', location: 'Á∂≤ÁæéÊôØÈªû', price: '¬•1000' },
                        { time: '13:13', category: '‰∫§ÈÄö', name: '‰∏äË∂äÊñ∞ÂππÁ∑ö (ËøîÂõû‰∏äÈáé)', location: 'ÂæÄÊù±‰∫¨', note: 'ÂõûÁ®ã' },
                        { time: '14:35', category: 'ÁæéÈ£ü', name: 'HARBS ÁîúÈªû (Â§ñÂ∏∂)', location: 'Parco_ya ‰∏äÈáéÂ∫ó', note: 'ÂÖàÂõûÊ∞ëÂÆøÂÜ∞' },
                        { time: '14:40', category: '‰ΩèÂÆø', name: 'Ueno Retro Flower', location: 'Ê∞ëÂÆø Check-in', note: 'Parco_ya ÊóÅ' },
                        { time: '15:00', category: 'Ë≥ºÁâ©', name: 'ÈòøÁæéÊ©´Áî∫', location: '‰∏äÈáé', note: 'ËÇâÁöÑÂ§ßÂ±±„ÄÅOS Drug„ÄÅ‰∫åÊú®ËèìÂ≠ê' },
                        { time: '17:00', category: 'ÊôØÈªû', name: 'Êù±‰∫¨Â∑®ËõãÂüé', location: 'LaQua / Èõ≤ÈúÑÈ£õËªä', note: 'ÁúãÂÜ¨Â≠£ÈªûÁáà' },
                        { time: '21:00', category: 'ÁæéÈ£ü', name: 'ÂÇôÈï∑ È∞ªÈ≠öÈ£Ø / Â£ΩÂñúÁáí', location: 'Êô¥Á©∫Â°î', note: 'ÊôöÈ§ê' },
                    ],
                    3: [ // Day 4 Mon
                        { time: '07:30', category: 'ÁæéÈ£ü', name: 'Komeda\'s Coffee', location: '‰∏äÈáéÂª£Â∞èË∑ØÂ∫ó', note: 'Êó©È§ê' },
                        { time: '09:30', category: 'ÊôØÈªû', name: 'ÂìàÂà©Ê≥¢ÁâπÂΩ±Âüé', location: 'Ë±êÂ≥∂Âúí', note: 'È†êË®àÂÅúÁïô 4hr' },
                        { time: '14:00', category: 'ÁæéÈ£ü', name: 'Â¨âÂ¨âË±öÁÇ∏Ë±¨Êéí', location: 'Ê±†Ë¢ã', price: '¬•3500' },
                        { time: '14:50', category: 'Ë≥ºÁâ©', name: 'mic21 ÊΩõÊ∞¥Ë£ùÂÇô & ÁîúÈªû', location: 'Ê±†Ë¢ã', note: 'RINGO ËòãÊûúÊ¥æ„ÄÅËï®È§Ö' },
                        { time: '17:00', category: 'ÁæéÈ£ü', name: 'ÈáëÊæ§ÁæéÂë≥Â£ΩÂè∏', location: 'Parco_ya 6F', note: '‰∏äÈáé' },
                        { time: '18:00', category: 'Ë≥ºÁâ©', name: 'Montbell', location: 'Âæ°ÂæíÁî∫Â∫ó', note: '' },
                        { time: '20:00', category: 'Ë≥ºÁâ©', name: 'Â§öÊÖ∂Â±ã (TAKEYA)', location: '‰∏äÈáé', note: 'Ë≤∑‰º¥ÊâãÁ¶Æ' },
                        { time: '22:00', category: 'ÁæéÈ£ü', name: 'È¥®toËî• / È≥•Ë≤¥Êóè', location: '‰∏äÈáé', price: '¬•1500', note: 'ÂÆµÂ§ú' },
                    ],
                    4: [ // Day 5 Tue
                        { time: '07:00', category: 'ÁæéÈ£ü', name: 'Denny\'s ÂÆ∂Â∫≠È§êÂª≥', location: 'ÊπØÂ≥∂Â∫ó', note: 'Êó©È§ê' },
                        { time: '08:00', category: '‰∫§ÈÄö', name: 'Skyliner (08:20)', location: '‰∫¨Êàê‰∏äÈáé -> ÊàêÁî∞', note: '‚ö†Ô∏è Áµï‰∏çËÉΩÈÅ≤Âà∞' },
                        { time: '09:05', category: 'Ëà™Áè≠', name: 'ÊàêÁî∞Ê©üÂ†¥ (TR899)', location: 'Á¨¨ 1 Ëà™Âªà', note: '11:45 Ëµ∑È£õ' },
                        { time: '09:20', category: 'Ë≥ºÁâ©', name: 'Fa-So-La ÂÖçÁ®ÖÂ∫ó', location: 'Ê©üÂ†¥ÁÆ°Âà∂ÂçÄ', note: 'ÊúÄÂæåÊé°Ë≤∑' },
                    ]
                };

                // SHOPPING DATA
                // Structure: { 'Âë®Áëæ': [], 'ÁéâËèØ': [], '‰Ω≥Ëìâ': [] }
                const shoppingList = ref(JSON.parse(localStorage.getItem('shoppingList_v2')) || {
                    'Âë®Áëæ': [{ name: 'ÁôΩËâ≤ÊàÄ‰∫∫', image: null, bought: false }],
                    'ÁéâËèØ': [],
                    '‰Ω≥Ëìâ': []
                });
                const currentShoppingUser = ref(null);

                // EXPENSES DATA
                // Group: [ { name, amount, payer: 'Âë®Áëæ' } ]
                // Personal: { 'Âë®Áëæ': [ { name, amount, date } ] }
                const groupExpenses = ref(JSON.parse(localStorage.getItem('groupExpenses')) || []);
                const personalExpenses = ref(JSON.parse(localStorage.getItem('personalExpenses')) || {
                    'Âë®Áëæ': [], 'ÁéâËèØ': [], '‰Ω≥Ëìâ': []
                });

                const currentExpenseTab = ref('group');
                const currentExpenseUser = ref(null);

                // MODAL STATES
                const showAddShoppingModal = ref(false);
                const showBoughtModal = ref(false);
                const showAddExpenseModal = ref(false);

                // FORMS
                const newShoppingItem = ref({ name: '', image: null });
                const selectedShoppingItem = ref(null);
                const selectedShoppingIndex = ref(-1);
                const boughtForm = ref({ isBought: false, price: '' });
                const newExpense = ref({ name: '', amount: '', payer: 'Âë®Áëæ' });

                // Computed
                const currentDayItinerary = computed(() => itineraryData[currentDayIndex.value] || []);

                const calculatedTWD = computed(() => {
                    if (!exchangeAmount.value) return 0;
                    return Math.round(exchangeAmount.value * exchangeRate.value);
                });

                const totalGroupExpense = computed(() => {
                    return groupExpenses.value.reduce((sum, item) => sum + Number(item.amount), 0);
                });

                const getPersonalTotal = (user) => {
                    return personalExpenses.value[user].reduce((sum, item) => sum + Number(item.amount), 0);
                };

                // Methods
                const openGoogleMaps = (name) => {
                    window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(name)}`, '_blank');
                };

                // Shopping
                const handleImageUpload = (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => newShoppingItem.value.image = e.target.result;
                        reader.readAsDataURL(file);
                    }
                };

                const addShoppingItem = () => {
                    if (!newShoppingItem.value.name) return;
                    shoppingList.value[currentShoppingUser.value].push({
                        name: newShoppingItem.value.name,
                        image: newShoppingItem.value.image,
                        bought: false
                    });
                    showAddShoppingModal.value = false;
                    newShoppingItem.value = { name: '', image: null };
                };

                const openBoughtModal = (item, index) => {
                    selectedShoppingItem.value = item;
                    selectedShoppingIndex.value = index;
                    boughtForm.value = { isBought: item.bought, price: item.boughPrice || '' };
                    showBoughtModal.value = true;
                };

                const confirmBought = () => {
                    const user = currentShoppingUser.value;
                    const item = shoppingList.value[user][selectedShoppingIndex.value];

                    // Update bought status
                    item.bought = boughtForm.value.isBought;

                    if (item.bought && boughtForm.value.price) {
                        item.boughPrice = boughtForm.value.price;
                        // Auto add to personal expense
                        personalExpenses.value[user].push({
                            name: item.name,
                            amount: boughtForm.value.price,
                            date: new Date().toISOString().split('T')[0]
                        });
                        alert(`Â∑≤Ëá™ÂãïÂ∞á ¬•${boughtForm.value.price} Âä†ÂÖ• ${user} ÁöÑÂÄã‰∫∫Â∏≥Êú¨ÔºÅ`);
                    }

                    showBoughtModal.value = false;
                };

                // Expenses
                const addExpense = () => {
                    if (!newExpense.value.name || !newExpense.value.amount) return;

                    if (currentExpenseTab.value === 'group') {
                        groupExpenses.value.push({
                            name: newExpense.value.name,
                            amount: newExpense.value.amount,
                            payer: newExpense.value.payer
                        });
                    } else {
                        // Personal
                        // If we are in 'All' view, use payer from select. If inside folder, use currentUser
                        const targetUser = currentExpenseUser.value || newExpense.value.payer;
                        personalExpenses.value[targetUser].push({
                            name: newExpense.value.name,
                            amount: newExpense.value.amount,
                            date: new Date().toISOString().split('T')[0]
                        });
                    }

                    showAddExpenseModal.value = false;
                    newExpense.value = { name: '', amount: '', payer: users[0] };
                };

                const deleteGroupExpense = (item) => {
                    const idx = groupExpenses.value.indexOf(item);
                    if (idx > -1 && confirm("Á¢∫ÂÆöÂà™Èô§Ê≠§Á≠ÜÂÖ¨Ë≤ªÔºü")) groupExpenses.value.splice(idx, 1);
                };

                const deletePersonalExpense = (user, index) => {
                    if (confirm("Á¢∫ÂÆöÂà™Èô§Ê≠§Á≠ÜÂÄã‰∫∫Ëä±Ë≤ªÔºü")) personalExpenses.value[user].splice(index, 1);
                };

                // Watchers for persistence
                watch([shoppingList, groupExpenses, personalExpenses], () => {
                    localStorage.setItem('shoppingList_v2', JSON.stringify(shoppingList.value));
                    localStorage.setItem('groupExpenses', JSON.stringify(groupExpenses.value));
                    localStorage.setItem('personalExpenses', JSON.stringify(personalExpenses.value));
                }, { deep: true });

                return {
                    currentTab, tabs: [
                        { id: 'itinerary', icon: 'fas fa-map-marked-alt' },
                        { id: 'info', icon: 'fas fa-info' },
                        { id: 'shopping', icon: 'fas fa-shopping-basket' },
                        { id: 'expenses', icon: 'fas fa-yen-sign' }
                    ],
                    days, currentDayIndex, currentDayItinerary,
                    exchangeRate, exchangeAmount, calculatedTWD,
                    users, groupExpenses, personalExpenses,
                    // Shopping
                    shoppingList, currentShoppingUser, showAddShoppingModal, newShoppingItem,
                    handleImageUpload, addShoppingItem,
                    showBoughtModal, selectedShoppingItem, boughtForm, openBoughtModal, confirmBought,
                    // Expenses
                    currentExpenseTab, currentExpenseUser, totalGroupExpense, getPersonalTotal,
                    showAddExpenseModal, newExpense, addExpense, deleteGroupExpense, deletePersonalExpense,
                    openGoogleMaps
                };
            }
        }).mount('#app');
    </script>
</body>

</html>